#include "bitmap.h"
#include "stb_image.h"
#include <cstring>
#include <fstream>
#include <sstream>

Bitmap::Bitmap(const std::string& fileName)
{
	int numColorComponents;
	unsigned char* pixels = stbi_load(fileName.c_str(), &m_width, &m_height, &numColorComponents, 4);
	
	m_image = new int[m_width * m_height];
	
	for(int i = 0; i < m_width * m_height; i++)
	{
		m_image[i] = (pixels[i*4 + 0] << 16) | (pixels[i*4 + 1] << 8) | pixels[i*4 + 2];
	}
	
	stbi_image_free(pixels);
}

Bitmap::Bitmap(int width, int height)
{
	m_image = new int[width * height];
	m_width = width;
	m_height = height;
	memset(m_image, 0, width*height);
}
	
Bitmap::~Bitmap()
{
	if(m_image) delete m_image;
}

void Bitmap::DrawPixel(unsigned int x, unsigned int y, const Vector3f& color)
{
	int r = ((int)(Clamp(color.GetX(), 0.0f, 1.0f) * 255)) & 0xFF;
	int g = ((int)(Clamp(color.GetY(), 0.0f, 1.0f) * 255)) & 0xFF;
	int b = ((int)(Clamp(color.GetZ(), 0.0f, 1.0f) * 255)) & 0xFF;
	
	unsigned int index = x + m_width * y;
	
	m_pixels[index] = (r << 16) | (g << 8) | b;
}

void Bitmap::Save(const std::string& fileName)
{
	std::ofstream output;
	output.open(fileName.c_str());
	
	std::ostringstream header;
	header << "P6 " << m_width << " " << m_height << " 255 ";	
	output << header.str();
	
	for(int j = 0; j < m_height; j++)
	{
		for(int i = 0; i < m_width; i++)
		{
			int currentPixel = m_image[i + j * m_width];
			
			unsigned char r = (char)((currentPixel >> 16) & 0xFF);
			unsigned char g = (char)((currentPixel >> 8) & 0xFF);
			unsigned char b = (char)((currentPixel >> 0) & 0xFF);
			
			output << r << g << b;
		}
	}
	
	output.close();
}
